# How does ColdFusion works? #

Have you every wondered what does exactly happen behind the scenes when a ColdFusion template is being requested via HTTP?

The very first thing you have to know is that all CF templates are transformed into JAVA servlets that are being invoked by the engine when processing a **.cfm request. When that happens a**run**methods gets invoked. All your CF code is presents in that method.**

In order to generate a JAVA byte-code from CF meta-language an [Apache BCEL](http://commons.apache.org/proper/commons-bcel/) engineering tool is used.

# Tool Composites #

The Code Coverage tool comes in two parts at the moment: statistics collector (JAVA) and statistics visualizer (CFM).

## The collector ##

The collector consists of a singleton **TemplateCoverageTool** instance which is being invoked whenever a ColdFusion template is processed and transformed into a JAVA byte-code. This is the moment when a template gets "covered" meaning that the line which is parsed is remembered in a corresponding **TemplateStatistics** instance. At this moment the generated byte-code is extended with additional invocation of **generateLineNo** method which is used by the engine to remember the original line in CFM template.

Later on when the byte-code is executed a reference those additional line number setters are used as a pointcut for AspectJ weaver. An aspect if woven around them and arbitrary **TemplateCoverageTool** code is executed at this point. This is where particular line is marked as visited (previously only covered).

Having covered and visited line count it's possible to calculate the coverage percentage. Additionally it's possible to show exactly which lines were visited and which were not.

## The visualization ##

The statistics presentation layer is written in ColdFusion and is shipped as 2 templates: one for showing overall application code coverage statistics and the second one showing detailed coverage statistics of a single template.

# Limitations #

The tool is able to provide code coverage statistics only when the template is compiled at runtime. This means that if you're using _trusted cache_ mechanism (storing generated byte-code on disc) you have to clear it after each server restart (either via Cf admin panel or manually).

# Know issues #

I've seen one example when the modified byte-code did not work. This was were extreme situation when the generated JAVA method was too long. This happened because the original CFC template had a single method that was 1300 lines long! If you have such a situation then it rather means you have to correct it as it's horrible to maintain :)